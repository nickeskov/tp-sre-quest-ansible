---
- name: Instlal php-fpm 7.4 basic components deb
  ansible.builtin.apt:
    update_cache: true
    name: 
      - php7.4-fpm
      - php7.4-common
      - php7.4-cli
    state: present
  notify: 
    - start php7.4-fpm

- name: Instlal additional php-fpm 7.4 components deb
  ansible.builtin.apt:
    update_cache: true
    name:
      - php7.4-mysqlnd
      - php7.4-json
      - php7.4-curl
      - php7.4-opcache
      - php7.4-mbstring
      - php7.4-xml
      - php7.4-gd
      - php7.4-readline
      - php7.4-ldap
      - php7.4-xmlrpc
      - php7.4-snmp
      - php7.4-soap
    state: present
  notify: 
    - reload php7.4-fpm

- name: Change listen php-fpm 7.4 endpoint to selected ip:port
  ansible.builtin.lineinfile:
    dest: "/etc/php/7.4/fpm/pool.d/www.conf"
    regexp: "^listen ="
    line: "listen = {{ php_fpm_listen_ip }}:{{ php_fpm_listen_port }}"
    state: present
    validate: 'php-fpm7.4 -ty %s'
  notify: 
    - reload php7.4-fpm
  when: 
   - not ansible_check_mode
 
- name: Change listen.allowed_clients php-fpm 7.4 to selected
  ansible.builtin.lineinfile:
    dest: "/etc/php/7.4/fpm/pool.d/www.conf"
    regexp: '^(;)?\s*listen.allowed_clients ='
    line: "listen.allowed_clients = {{ php_fpm_listen_allowed_clients }}"
    state: present
    validate: 'php-fpm7.4 -ty %s'
  notify: 
    - reload php7.4-fpm
  when: 
   - not ansible_check_mode
